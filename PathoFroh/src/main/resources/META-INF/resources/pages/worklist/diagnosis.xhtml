<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core">

    <h:outputScript library="scripts" name="closeOverlayPanelOnReturn.js"/>

    <ui:include src="include/navigationBar.xhtml"></ui:include>

    <script type="text/javascript">
        // disables the autofocus for the caseHistoryOverlayplpanel
        (function () {
            var proxied = PrimeFaces.widget.OverlayPanel.prototype.applyFocus;
            PrimeFaces.widget.OverlayPanel.prototype.applyFocus = function () {
                if (this.jq.hasClass("histoOverlayPanel")) {
                    return;
                }
                return proxied.apply(this, arguments);
            };
        })();
    </script>

    <p:panel style="width: 80%"
             styleClass="defaultHistoHiddenTableContainer">

        <h:outputLabel value="#{msg['body.diagnosis.headline']}"
                       style="font-size:1.5em;"></h:outputLabel>

        <h:panelGrid columns="3" style="margin-top:10px;"
                     styleClass="defaultHistoHiddenTableContainer"
                     columnClasses="columnTop, , columnTop">

            <!-- Left Column -->
            <h:panelGrid columns="1" styleClass="defaultHistoTable">

                <h:panelGrid columns="1"
                             styleClass="defaultHistoHiddenTableContainer">

                    <!-- material -->
                    <c:forEach items="#{worklistHandler.current.selectedTask.samples}"
                               var="sample" varStatus="loopCount">

                        <h:panelGrid columns="2" styleClass="defaultHistoTable"
                                     columnClasses="columnWidth75,">

                            <h:outputLabel
                                    value="#{msg['body.diagnosis.sample']} #{sample.sampleID}"/>

                            <h:panelGroup>
                                <!-- Material Name -->
                                <p:inputText value="#{sample.material}"
                                             id="materialInput#{loopCount.index}"
                                             disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                             tabindex="1" styleClass="customBackground"
                                             onclick="showAndUpdateOverlayPanel('materialOverlayPanel#{loopCount.index}', '#{component.clientId}' ,null, 'materialOverlayPanelDataTable#{loopCount.index}', 0, submitUpdateMaterial#{loopCount.index});"
                                             style="width:200px;float:right;background:##{userHandlerAction.currentUser.settings.inputFieldColor};color:##{userHandlerAction.currentUser.settings.inputFieldFontColor}">

                                    <p:ajax event="change" execute="@this"
                                            listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.material', sample.task, sample ,sample.material)}"/>
                                </p:inputText>

                                <!-- material overlay panel -->
                                <p:overlayPanel id="materialOverlayPanel#{loopCount.index}"
                                                widgetVar="materialOverlayPanel#{loopCount.index}"
                                                styleClass="histoOverlayPanel" hideEffect="fade"
                                                style="width:500px" hideEvent="mousedown" showEvent="none"
                                                onkeypress="return false;">
                                    <p:dataTable filterDelay="50"
                                                 id="materialOverlayPanelDataTable#{loopCount.index}"
                                                 widgetVar="materialOverlayPanelDataTable#{loopCount.index}"
                                                 value="#{globalEditViewHandler.genericView.staticData.materialList}"
                                                 var="preset" styleClass="defaultHistoDataTable"
                                                 scrollable="true" scrollHeight="200" rowKey="#{preset.id}"
                                                 selection="#{globalEditViewHandler.genericView.selectedMaterialPresets[loopCount.index]}"
                                                 selectionMode="single">

                                        <p:column filterBy="#{preset.name}" filterMatchMode="contains"
                                                  filterValue="#{globalEditViewHandler.genericView.selectedMaterialPresetFilter[loopCount.index]}"
                                                  id="presetName">
                                            <h:outputText value="#{preset.name}"/>
                                        </p:column>

                                        <p:ajax event="rowSelect"
                                                process="contentForm:materialOverlayPanel#{loopCount.index}"
                                                partialSubmit="true"
                                                update="contentForm:materialInput#{loopCount.index}"
                                                listener="#{globalEditViewHandler.ct.updateMaterialOfSample(sample, globalEditViewHandler.genericView.selectedMaterialPresets[loopCount.index])}"
                                                oncomplete="PF('materialOverlayPanel#{loopCount.index}').hide();"/>
                                    </p:dataTable>
                                </p:overlayPanel>

                                <p:remoteCommand name="submitUpdateMaterial#{loopCount.index}"
                                                 partialSubmit="true"
                                                 update="navigationForm:patientList contentForm:contentPanel headerForm"
                                                 actionListener="#{globalEditViewHandler.ct.updateMaterialOfSampleWithName(sample, globalEditViewHandler.genericView.selectedMaterialPresetFilter[loopCount.index])}"
                                                 oncomplete="PF('materialOverlayPanel#{loopCount.index}').hide();"/>

                            </h:panelGroup>
                        </h:panelGrid>
                    </c:forEach>
                </h:panelGrid>
                <!-- material -->

                <!-- Eye -->
                <h:panelGrid columns="2" styleClass="defaultHistoTable">
                    <h:outputLabel value="#{msg['body.diagnosis.eye']}"/>
                    <p:selectOneMenu styleClass="customBackground" tabindex="6"
                                     style="background:##{userHandlerAction.currentUser.settings.inputFieldColor};color:##{userHandlerAction.currentUser.settings.inputFieldFontColor}"
                                     disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                     value="#{worklistHandler.current.selectedTask.eye}">

                        <f:selectItems value="#{enumProvider.eyes}" var="eye"
                                       itemLabel="#{msg['enum.eye.'.concat(eye)]}" itemValue="#{eye}"/>

                        <p:ajax event="change" execute="@this"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.eye',worklistHandler.current.selectedTask,worklistHandler.current.selectedTask.eye)}"/>
                    </p:selectOneMenu>

                </h:panelGrid>
                <!-- Eye -->

                <!-- history -->
                <h:panelGrid columns="1" styleClass="defaultHistoTable">
                    <h:outputLabel value="#{msg['body.diagnosis.story']}"/>

                    <h:panelGroup>
                        <p:inputTextarea styleClass="customBackground"
                                         value="#{worklistHandler.current.selectedTask.caseHistory}"
                                         title="#{msg['body.diagnosis.story.watermark']}"
                                         disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                         id="caseHistoryInput" style="width:90%"
                                         onclick="showAndUpdateOverlayPanel('caseHistoryOverlayPanel', '#{component.clientId}' ,null, 'caseHistoryOverlayPanelDataTable', 0,submitNewCustomCaseHistory);"
                                         onkeypress="PF('caseHistoryOverlayPanel').hide();">
                            <p:ajax event="change"
                                    listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.caseHistory',worklistHandler.current.selectedTask,worklistHandler.current.selectedTask.caseHistory)}"></p:ajax>
                        </p:inputTextarea>

                        <p:overlayPanel id="caseHistoryOverlayPanel"
                                        styleClass="histoOverlayPanel"
                                        widgetVar="caseHistoryOverlayPanel" hideEffect="fade"
                                        style="width:500px" hideEvent="mousedown" showEvent="none"
                                        onkeypress="return false;">
                            <p:dataTable id="caseHistoryOverlayPanelDataTable"
                                         widgetVar="caseHistoryOverlayPanelDataTable" filterDelay="50"
                                         value="#{globalEditViewHandler.genericView.staticData.caseHistoryList}"
                                         var="item" styleClass="defaultHistoDataTable" scrollable="true"
                                         scrollHeight="200" rowKey="#{item.id}"
                                         selection="#{globalEditViewHandler.genericView.selectedCaseHistoryItem}"
                                         selectionMode="single">

                                <p:column filterBy="#{item.value}" filterMatchMode="contains"
                                          filterValue="#{globalEditViewHandler.genericView.caseHistoryFilter}"
                                          id="valueColumn">
                                    <h:outputText value="#{item.value}"/>
                                </p:column>

                                <p:ajax event="rowSelect" update="contentForm:caseHistoryInput"
                                        process="contentForm:caseHistoryOverlayPanel"
                                        partialSubmit="true"
                                        listener="#{globalEditViewHandler.ct.updateCaseHistory(globalEditViewHandler.genericView.selectedCaseHistoryItem)}"
                                        oncomplete="PF('caseHistoryOverlayPanel').hide();"/>
                            </p:dataTable>
                        </p:overlayPanel>

                        <p:remoteCommand name="submitNewCustomCaseHistory"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         actionListener="#{globalEditViewHandler.ct.updateCaseHistoryWithName(globalEditViewHandler.genericView.caseHistoryFilter)}"
                                         oncomplete="PF('caseHistoryOverlayPanel').hide();"/>

                    </h:panelGroup>
                </h:panelGrid>
            </h:panelGrid>
            <!-- Left Column -->

            <h:panelGroup>
                <h:outputLabel value="" style="margin-left:40px"></h:outputLabel>
            </h:panelGroup>

            <!-- Right Column -->
            <h:panelGrid columns="1" styleClass="defaultHistoTable">

                <h:panelGrid columns="2" styleClass="defaultHistoTable">

                    <!-- Task Number -->
                    <h:outputLabel value="#{msg['body.diagnosis.taskNumber']}"/>
                    <h:panelGrid columns="2"
                                 styleClass="listingHistoHiddenTableContainer">
                        <p:inputText disabled="true"
                                     value="#{worklistHandler.current.selectedTask.taskID}"/>
                        <p:commandLink title="#{msg['body.diagnosis.taskNumber.change']}"
                                       rendered="#{userHandlerAction.currentUserHasPermission('TASK_EDIT_ID')}"
                                       disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                       actionListener="#{dialog.changeTaskIDDialog.initAndPrepareBean(worklistHandler.current.selectedTask)}">
                            <i class="fa fa-fw fa-cog"/>
                            <p:ajax event="dialogReturn"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandLink>
                    </h:panelGrid>

                    <!-- date of surgery -->
                    <h:outputLabel value="#{msg['body.diagnosis.surgeryDate']}"/>
                    <p:calendar pattern="dd.MM.yyyy" mask="true" tabindex="2" converter="localDateConverter"
                                style="background:##{userHandlerAction.currentUser.settings.inputFieldColor};color:##{userHandlerAction.currentUser.settings.inputFieldFontColor}"
                                styleClass="customBackground"
                                timeZone="Europe/Berlin"
                                disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                value="#{worklistHandler.current.selectedTask.dateOfSugery}">
                        <p:ajax event="dateSelect"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.dateOfSurgery',worklistHandler.current.selectedTask,'date:'.concat(worklistHandler.current.selectedTask.dateOfSugery))}"/>
                        <f:ajax event="change" execute="@this"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.dateOfSurgery',worklistHandler.current.selectedTask,'date:'.concat(worklistHandler.current.selectedTask.dateOfSugery))}"/>
                    </p:calendar>

                    <!-- date of receipt -->
                    <h:outputLabel value="#{msg['body.diagnosis.taskEDate']}"/>
                    <p:calendar pattern="dd.MM.yyyy" mask="true" tabindex="3" converter="localDateConverter"
                                disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                style="background:##{userHandlerAction.currentUser.settings.inputFieldColor};color:##{userHandlerAction.currentUser.settings.inputFieldFontColor}"
                                styleClass="customBackground"
                                timeZone="Europe/Berlin"
                                value="#{worklistHandler.current.selectedTask.dateOfReceipt}">
                        <p:ajax event="dateSelect"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.receiptDate',worklistHandler.current.selectedTask,'date:'.concat(worklistHandler.current.selectedTask.dateOfReceipt))}"/>
                        <f:ajax event="change" execute="@this"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.receiptDate',worklistHandler.current.selectedTask,'date:'.concat(worklistHandler.current.selectedTask.dateOfReceipt))}"/>
                    </p:calendar>

                    <!-- insurance -->
                    <h:outputLabel value="#{msg['body.diagnosis.insurance']}"/>
                    <p:inputText
                            disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                            value="#{worklistHandler.current.selectedTask.insurance}">
                        <p:ajax event="change" execute="@this"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.insurance',worklistHandler.current.selectedTask,worklistHandler.current.selectedTask.insurance)}"/>
                    </p:inputText>

                    <!-- ward -->
                    <h:outputLabel value="#{msg['body.diagnosis.ward']}"/>
                    <p:selectOneMenu id="wards"
                                     value="#{worklistHandler.current.selectedTask.ward}"
                                     editable="true"
                                     disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                     styleClass="customBackground" tabindex="5"
                                     style="background:##{userHandlerAction.currentUser.settings.inputFieldColor};color:##{userHandlerAction.currentUser.settings.inputFieldFontColor}">

                        <f:selectItems
                                value="#{globalEditViewHandler.genericView.staticData.wardList}"
                                itemValue="#{ward.value}" itemLabel="#{ward.value}" var="ward"/>
                        <p:ajax event="change" execute="@this"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.ward', worklistHandler.current.selectedTask, worklistHandler.current.selectedTask.ward)}"/>
                    </p:selectOneMenu>

                    <!-- surgeon -->
                    <h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
                        <h:outputLabel value="#{msg['body.diagnosis.surgeon']}"/>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
                        <h:outputLabel style="margin-left:10px;"
                                       value="#{worklistHandler.current.selectedTask.getPrimaryContact('SURGEON', 'EXTERNAL_SURGEON')}"></h:outputLabel>

                        <h:panelGroup>
                            <p:commandLink style="float: right; margin-right:5px;"
                                           tabindex="9"
                                           onclick="showAndUpdateOverlayPanel('surgeonPhysicianOverlayPanel', '#{component.clientId}' , null, 'surgeonPhysicianOverlayPanelDataTable', 0 ,null);"
                                           title="#{msg['body.receiptlog.notification.ophthalmologist.hint']}"
                                           disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}">
                                <i class="fa fa-fw fa-scissors"/>
                            </p:commandLink>

                            <!-- surgeon overlay panel -->
                            <p:overlayPanel id="surgeonPhysicianOverlayPanel"
                                            styleClass="histoOverlayPanel"
                                            widgetVar="surgeonPhysicianOverlayPanel" hideEffect="fade"
                                            style="width:500px" hideEvent="mousedown" showEvent="none"
                                            onkeypress="return false;">

                                <p:dataTable id="surgeonPhysicianOverlayPanelDataTable"
                                             widgetVar="surgeonPhysicianOverlayPanelDataTable"
                                             disabledSelection="#{physicianSelector.contactOfTask}"
                                             selection="#{globalEditViewHandler.genericView.selectedSurgeon}"
                                             selectionMode="single"
                                             value="#{globalEditViewHandler.genericView.surgeons}"
                                             var="physicianSelector" styleClass="defaultHistoDataTable"
                                             scrollable="true" scrollHeight="200"
                                             rowKey="#{physicianSelector.id}" rowIndexVar="rowId">

                                    <!-- name -->
                                    <p:column id="nameColumn" style="width:auto"
                                              filterValue="#{globalEditViewHandler.genericView.selectedSurgeonFilter}"
                                              filterBy="#{physicianSelector.physician.person.getFullName()}"
                                              filterMatchMode="contains">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.person.getFullName()}"/>
                                    </p:column>

                                    <!-- role -->
                                    <p:column style="width: 30%">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.clinicRole}"/>
                                    </p:column>

                                    <!-- already selected -->
                                    <p:column style="width:5%; text-align:center;">
                                        <f:facet name="header">
                                            <i class="fa fa-check-square-o"
                                               title="#{msg['dialog.selectContact.table.added']}"/>
                                        </f:facet>

                                        <ui:fragment rendered="#{physicianSelector.contactOfTask}">
                                            <i class="fa fa-check icon-green"
                                               title="#{msg['dialog.selectContact.table.added']}"/>
                                        </ui:fragment>

                                    </p:column>


                                    <p:ajax event="rowSelect"
                                            update="navigationForm:patientList contentForm:contentPanel headerForm"
                                            process="contentForm:surgeonPhysicianOverlayPanelDataTable"
                                            partialSubmit=""
                                            listener="#{globalEditViewHandler.ct.addPhysicianWithRole(globalEditViewHandler.genericView.selectedSurgeon.physician.person, 'SURGEON')}"
                                            oncomplete="PF('surgeonPhysicianOverlayPanel#{loopCount.index}').hide();"/>

                                </p:dataTable>
                            </p:overlayPanel>
                        </h:panelGroup>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
                        <h:outputLabel value="#{msg['body.diagnosis.privatePhysician']}"></h:outputLabel>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
                        <h:outputLabel style="margin-left:10px;"
                                       value="#{worklistHandler.current.selectedTask.getPrimaryContact('PRIVATE_PHYSICIAN')}"></h:outputLabel>

                        <h:panelGroup>
                            <p:commandLink style="float: right; margin-right:5px;"
                                           tabindex="9"
                                           onclick="showAndUpdateOverlayPanel('privatePhysicianPhysicianOverlayPanel', '#{component.clientId}' , null, 'privatePhysicianPhysicianOverlayPanelDataTable', 0 ,null);"
                                           title="#{msg['body.receiptlog.notification.ophthalmologist.hint']}"
                                           disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}">
                                <i class="fa fa-fw fa-eye"/>
                            </p:commandLink>

                            <!-- private physician overlay panel -->
                            <p:overlayPanel id="privatePhysicianPhysicianOverlayPanel"
                                            styleClass="histoOverlayPanel"
                                            widgetVar="privatePhysicianPhysicianOverlayPanel"
                                            hideEffect="fade" style="width:500px" hideEvent="mousedown"
                                            showEvent="none" onkeypress="return false;">

                                <p:dataTable id="privatePhysicianPhysicianOverlayPanelDataTable"
                                             widgetVar="privatePhysicianPhysicianOverlayPanelDataTable"
                                             disabledSelection="#{physicianSelector.contactOfTask}"
                                             selection="#{globalEditViewHandler.genericView.selectedPrivatePhysician}"
                                             selectionMode="single"
                                             value="#{globalEditViewHandler.genericView.privatePhysicians}"
                                             var="physicianSelector" styleClass="defaultHistoDataTable"
                                             scrollable="true" scrollHeight="200"
                                             rowKey="#{physicianSelector.id}" rowIndexVar="rowId">

                                    <!-- name -->
                                    <p:column id="nameColumn" style="width:auto"
                                              filterValue="#{globalEditViewHandler.genericView.selectedPrivatePhysicianFilter}"
                                              filterBy="#{physicianSelector.physician.person.getFullName()}"
                                              filterMatchMode="contains">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.person.getFullName()}"/>
                                    </p:column>

                                    <!-- role -->
                                    <p:column style="width: 30%">
                                        <h:outputText
                                                style="#{physicianSelector.contactOfTask ? 'opacity: 0.3;' : ''}"
                                                value="#{physicianSelector.physician.clinicRole}"/>
                                    </p:column>

                                    <!-- already selected -->
                                    <p:column style="width:5%; text-align:center;">
                                        <f:facet name="header">
                                            <i class="fa fa-check-square-o"
                                               title="#{msg['dialog.selectContact.table.added']}"/>
                                        </f:facet>

                                        <ui:fragment rendered="#{physicianSelector.contactOfTask}">
                                            <i class="fa fa-check icon-green"
                                               title="#{msg['dialog.selectContact.table.added']}"/>
                                        </ui:fragment>

                                    </p:column>


                                    <p:ajax event="rowSelect"
                                            update="navigationForm:patientList contentForm:contentPanel headerForm"
                                            process="contentForm:privatePhysicianPhysicianOverlayPanel"
                                            partialSubmit="true"
                                            listener="#{globalEditViewHandler.ct.addPhysicianWithRole(globalEditViewHandler.genericView.selectedPrivatePhysician.physician.person, 'PRIVATE_PHYSICIAN')}"
                                            oncomplete="PF('privatePhysicianPhysicianOverlayPanel#{loopCount.index}').hide();"/>

                                </p:dataTable>
                            </p:overlayPanel>
                        </h:panelGroup>
                    </h:panelGroup>
                </h:panelGrid>
            </h:panelGrid>
            <!-- Right Column -->

        </h:panelGrid>

        <!-- Diagnoses -->
        <c:forEach
                items="#{worklistHandler.current.selectedTask.diagnosisRevisions}"
                varStatus="varCounterOuter" var="revision">

            <p:separator/>

            <!-- spot light -->
            <p:spotlight target="diagnosisSpotContent#{varCounterOuter.index}"
                         widgetVar="diagnosisSpotBlocker#{varCounterOuter.index}"/>

            <h:panelGrid id="diagnosisSpotContent#{varCounterOuter.index}"
                         styleClass="defaultHistoHiddenTableContainer" style="width:100%">

                <h:panelGrid columns="2" styleClass="defaultHistoTable"
                             id="diagnosisSpotDiagnosis#{varCounterOuter.index}"
                             columnClasses="columnWidth200 columnTop #{varCounterOuter.even ? '' : 'oddColumnColored' }, #{varCounterOuter.even ? '' : 'oddColumnColored'}">

                    <!-- Extended Diagnosis Text -->
                    <h:panelGroup layout="block" id="pPannel"
                                  style="width: 90%; min-height:16px; #{revision.name == '' ? 'background: #fcf1b8' : ''}"
                                  onclick="PF('diagnosisNamePannel#{varCounterOuter.index}').show()">
                        <h:outputLabel value="#{revision.name}"/>

                        <p:overlayPanel id="diagnosisNamePannel#{varCounterOuter.index}"
                                        onHide="saveDiagnosisNameChange()" styleClass="histoOverlayPanel"
                                        widgetVar="diagnosisNamePannel#{varCounterOuter.index}"
                                        hideEffect="fade" hideEvent="none" showEvent="none">
                            <p:inputText id="nameInputPannelInput#{varCounterOuter.index}"
                                         onkeypress="return closeOverlayPanelOnReturn(event, 'diagnosisNamePannel#{varCounterOuter.index}')"
                                         disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                         value="#{revision.name}"/>
                        </p:overlayPanel>

                        <p:remoteCommand
                                actionListener="#{globalEditViewHandler.ct.saveData('log.patient.task.diagnosisRevision.diagnosis.name',  revision.task,  revision, revision.name)}"
                                name="saveDiagnosisNameChange"
                                update="navigationForm:patientList contentForm:contentPanel headerForm"/>

                    </h:panelGroup>

                    <h:panelGroup id="extendedTextParent">
                        <p:inputTextarea style="width:99%" id="extendedText" rows="15"
                                         disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                         value="#{revision.text}">
                            <p:ajax event="keyup" execute="@this" delay="1000"
                                    listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.histologicalRecord',  revision.task,  revision, revision.text)}"/>
                            <p:ajax event="change" execute="@this"
                                    listener="#{globalEditViewHandler.ct.saveData('log.patient.task.change.histologicalRecord',  revision.task,  revision, revision.text)}"/>
                        </p:inputTextarea>
                    </h:panelGroup>
                    <!-- Extended Diagnosis Text -->

                    <!-- Diagnosis for sample -->
                    <c:forEach items="#{revision.diagnoses}"
                               varStatus="varCounterInner" var="diagnosis">

                        <c:choose>
                            <c:when test="#{varCounterInner.first}">
                                <h:outputLabel value="#{msg['body.diagnosis.diagnoses']}"></h:outputLabel>
                            </c:when>
                            <c:otherwise>
                                <h:outputLabel value=""/>
                            </c:otherwise>
                        </c:choose>

                        <h:panelGroup>
                            <!-- sample -->
                            <c:choose>
                                <c:when test="#{revision.diagnoses.size() ne 1}">
                                    <h:outputLabel
                                            value="#{msg['body.diagnosis.sample']} #{diagnosis.sample.sampleID}"/>
                                </c:when>
                                <c:otherwise>
                                    <h:outputLabel value=""/>
                                </c:otherwise>
                            </c:choose>
                            <h:panelGroup>
                                <!-- copy diagnosis text -->
                                <p:commandLink style="margin-left:20px;"
                                               disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision) or diagnosis.diagnosisPrototype.extendedDiagnosisText eq ''}"
                                               title="#{diagnosis.diagnosisPrototype.extendedDiagnosisText eq '' ? msg['body.diagnosis.histologicalRecordPreset.text.none'] : msg['body.diagnosis.histologicalRecordPreset.text']}"
                                               rendered="#{diagnosis.diagnosisPrototype ne null}"
                                               process="@this"
                                               actionListener="#{globalEditViewHandler.ct.copyHistologicalRecord(diagnosis)}"
                                               update="contentForm:contentPanel">
                                    <i class="fa fa-copy"></i>
                                    <p:ajax event="dialogReturn" update="contentForm:contentPanel"
                                            listener="#{dialogReturnHandler.onDefaultDialogReturn}"/>
                                </p:commandLink>
                            </h:panelGroup>
                            <!-- malign -->
                            <h:panelGrid columns="2" style="float:right;margin-right:20px;">
                                <h:outputLabel value="#{msg['body.diagnosis.malign']}"/>
                                <p:selectBooleanCheckbox value="#{diagnosis.malign}"
                                                         disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                                         style="margin:3px 0px 0px 3px;">
                                    <f:ajax event="change"
                                            listener="#{globalEditViewHandler.ct.saveData('log.patient.task.sample.diagnosis.changed.malign',diagnosis.malign)}"/>
                                </p:selectBooleanCheckbox>
                            </h:panelGrid>
                        </h:panelGroup>

                        <h:outputLabel/>
                        <h:panelGroup>
                            <!-- diagnosis text -->
                            <p:inputTextarea value="#{diagnosis.diagnosis}"
                                             onkeypress="PF('diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}').hide();"
                                             onclick="showAndUpdateOverlayPanel('diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}', '#{component.clientId}' , null, 'diagnosisOverlayPanelDataTable#{varCounterOuter.index}#{varCounterInner.index}', 'contentForm:diagnosisOverlayPanelDataTable#{varCounterOuter.index}#{varCounterInner.index}:diagnosisColumn:filter',submitNewCustomDiagnosis#{varCounterOuter.index}#{varCounterInner.index});"
                                             filterDelay="50"
                                             id="diagnosisText#{varCounterOuter.index}#{varCounterInner.index}"
                                             disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                             style="width:99%">
                                <p:watermark
                                        for="diagnosisText#{varCounterOuter.index}#{varCounterInner.index}"
                                        value="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.watermark']}"/>
                                <f:ajax event="change" execute="@this"
                                        listener="#{globalEditViewHandler.ct.saveData('log.patient.task.sample.diagnosis.changed.diagnosis.text', diagnosis.diagnosis)}"/>
                            </p:inputTextarea>


                            <p:overlayPanel
                                    widgetVar="diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}"
                                    id="diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}"
                                    styleClass="histoOverlayPanel" hideEffect="fade"
                                    style="width:500px" hideEvent="mousedown" showEvent="none">
                                <p:dataTable
                                        id="diagnosisOverlayPanelDataTable#{varCounterOuter.index}#{varCounterInner.index}"
                                        widgetVar="diagnosisOverlayPanelDataTable#{varCounterOuter.index}#{varCounterInner.index}"
                                        value="#{globalEditViewHandler.genericView.staticData.diagnosisPresets}"
                                        var="item" styleClass="defaultHistoDataTable" scrollable="true"
                                        scrollHeight="200" rowKey="#{item.id}"
                                        selection="#{globalEditViewHandler.genericView.selectedDiagnosisPresets[varCounterOuter.index][varCounterInner.index]}"
                                        selectionMode="single">

                                    <p:column filterBy="#{item.diagnosis}" id="diagnosisColumn"
                                              filterValue="#{globalEditViewHandler.genericView.diagnosisFilter[varCounterOuter.index][varCounterInner.index]}"
                                              filterMatchMode="contains">
                                        <h:outputText value="#{item.diagnosis}"/>
                                    </p:column>

                                    <p:ajax event="rowSelect"
                                            process="contentForm:diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}"
                                            partialSubmit="true"
                                            update="navigationForm:patientList contentForm:contentPanel headerForm"
                                            listener="#{globalEditViewHandler.ct.updateDiagnosisPrototype(diagnosis,globalEditViewHandler.genericView.selectedDiagnosisPresets[varCounterOuter.index][varCounterInner.index])}"
                                            oncomplete="PF('diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}').hide();"/>

                                </p:dataTable>

                                <p:remoteCommand partialSubmit="true"
                                                 process="contentForm:diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}"
                                                 name="submitNewCustomDiagnosis#{varCounterOuter.index}#{varCounterInner.index}"
                                                 update="navigationForm:patientList contentForm:contentPanel headerForm"
                                                 actionListener="#{globalEditViewHandler.ct.updateDiagnosisPrototype(diagnosis,globalEditViewHandler.genericView.diagnosisFilter[varCounterOuter.index][varCounterInner.index])}"
                                                 oncomplete="PF('diagnosisOverlayPanel#{varCounterOuter.index}#{varCounterInner.index}').hide();"/>

                            </p:overlayPanel>
                        </h:panelGroup>
                        <!-- Diagnosis for sample -->
                    </c:forEach>
                </h:panelGrid>

                <!-- ****************************** Signature ****************************** -->
                <h:panelGrid columns="6" styleClass="defaultHistoTable"
                             id="diagnosisSpotContentSignature#{varCounterOuter.index}"
                             columnClasses="columnLabelContainer200 columnTop #{varCounterOuter.even ? '' : 'oddColumnColored' }, #{varCounterOuter.even ? '' : 'oddColumnColored'}, #{varCounterOuter.even ? '' : 'oddColumnColored'}, #{varCounterOuter.even ? '' : 'oddColumnColored'}, #{varCounterOuter.even ? '' : 'oddColumnColored'}, #{varCounterOuter.even ? '' : 'oddColumnColored'}">

                    <h:outputLabel value="#{msg['body.diagnosis.signature.date']}"></h:outputLabel>
                    <p:calendar pattern="dd.MM.yyyy" mask="true"
                                disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                value="#{revision.signatureDateAsDate}">
                        <p:ajax event="dateSelect"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.diagnosisRevision.signautre.date', revision.task, revision, 'date:'.concat(revision.signatureDate))}"/>
                        <f:ajax event="change" execute="@this"
                                listener="#{globalEditViewHandler.ct.saveData('log.patient.task.diagnosisRevision.signautre.date', revision.task, revision, 'date:'.concat(revision.signatureDate))}"/>
                    </p:calendar>

                    <!-- physician -->
                    <h:outputLabel value="#{msg['body.diagnosis.signature.physician']}"/>
                    <h:panelGroup>
                        <p:selectOneMenu
                                disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                style="width:90% !important;"
                                panelStyleClass="iconFixForSelectOneMenu"
                                value="#{revision.signatureOne.physician}"
                                converter="#{globalEditViewHandler.genericView.staticData.physiciansToSignListTransformer}"
                                filter="true" filterMatchMode="contains">

                            <f:selectItem
                                    itemLabel="#{msg['body.diagnosis.signature.physician.select']}"
                                    itemValue="#{null}"/>

                            <f:selectItems
                                    value="#{globalEditViewHandler.genericView.staticData.physiciansToSignList}"
                                    var="physician" itemLabel="#{physician.person.getFullName()}"
                                    itemValue="#{physician}"/>

                            <p:ajax event="change"
                                    onstart="$('#contentForm\\:submitPhysicianChange').click();"/>

                        </p:selectOneMenu>

                        <p:commandButton style="display:none"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         id="submitPhysicianChange">
                            <f:actionListener
                                    binding="#{globalEditViewHandler.ct.changePhysiciansSignature(revision.signatureOne)}"/>
                            <f:actionListener
                                    binding="#{globalEditViewHandler.ct.saveData('log.patient.task.diagnosisRevision.signature.one',revision.task, revision, revision.signatureOne.physician.person.getFullName(), revision.signatureOne.role)}"/>
                        </p:commandButton>
                    </h:panelGroup>

                    <!-- Consultant -->
                    <h:outputLabel
                            value="#{msg['body.diagnosis.signature.consultant']}"/>
                    <h:panelGroup>
                        <p:selectOneMenu
                                disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                style="width:90% !important;"
                                panelStyleClass="iconFixForSelectOneMenu"
                                value="#{revision.signatureTwo.physician}"
                                converter="#{globalEditViewHandler.genericView.staticData.physiciansToSignListTransformer}"
                                filter="true" filterMatchMode="contains">
                            <f:selectItem
                                    itemLabel="#{msg['body.diagnosis.signature.consultant.select']}"
                                    itemValue="#{null}"/>

                            <f:selectItems
                                    value="#{globalEditViewHandler.genericView.staticData.physiciansToSignList}"
                                    var="physician" itemLabel="#{physician.person.getFullName()}"
                                    itemValue="#{physician}"/>

                            <p:ajax event="change"
                                    oncomplete="$('#contentForm\\:submitConsultantChange').click();"/>
                        </p:selectOneMenu>

                        <!-- hidden button for updating on consultant change -->

                        <p:commandButton style="display:none"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         id="submitConsultantChange">
                            <f:actionListener
                                    binding="#{globalEditViewHandler.ct.changePhysiciansSignature(revision.signatureTwo)}"/>
                            <f:actionListener
                                    binding="#{globalEditViewHandler.ct.saveData('log.patient.task.diagnosisRevision.signature.two',revision.task, revision, revision.signatureTwo.physician.person.getFullName(), revision.signatureTwo.role)}"/>

                        </p:commandButton>

                    </h:panelGroup>

                    <h:panelGroup/>
                    <h:panelGroup/>
                    <h:panelGroup/>

                    <!-- physician role -->
                    <h:panelGroup>
                        <p:selectOneMenu id="pysicianToSignRole" editable="true"
                                         style="width:90% !important;"
                                         disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                         value="#{revision.signatureOne.role}">
                            <f:selectItems value="#{enumProvider.signatureRoles}"
                                           var="signatureRole"
                                           itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
                                           itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}"/>
                            <p:ajax event="change"
                                    onstart="$('#contentForm\\:submitPhysicianRoleChange').click();"/>
                        </p:selectOneMenu>

                        <!-- hidden button for updating on physician role change -->

                        <p:commandButton style="display:none"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         id="submitPhysicianRoleChange">
                            <f:actionListener
                                    binding="#{globalEditViewHandler.ct.saveData('log.patient.task.diagnosisRevision.signature.one.role',revision.task, revision, revision.signatureOne.role)}"/>
                        </p:commandButton>
                    </h:panelGroup>

                    <h:panelGroup/>

                    <!-- Consultant role -->
                    <h:panelGroup>
                        <p:selectOneMenu id="consultantToSignRole" editable="true"
                                         style="width:90% !important"
                                         disabled="#{!worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionEditable(revision)}"
                                         value="#{revision.signatureTwo.role}">
                            <f:selectItems value="#{enumProvider.signatureRoles}"
                                           var="signatureRole"
                                           itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
                                           itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}"/>
                            <p:ajax event="change"
                                    oncomplete="$('#contentForm\\:submitConsultantRoleChange').click();"/>
                        </p:selectOneMenu>

                        <!-- hidden button for updating on consultant role change -->
                        <p:commandButton style="display:none"
                                         update="navigationForm:patientList contentForm:contentPanel headerForm"
                                         id="submitConsultantRoleChange">
                            <f:actionListener
                                    binding="#{globalEditViewHandler.ct.saveData('log.patient.task.diagnosisRevision.signature.two.role',revision.task, revision, revision.signatureTwo.role)}"/>
                        </p:commandButton>
                    </h:panelGroup>
                </h:panelGrid>


                <!-- Buttons -->
                <h:panelGrid columns="2" styleClass="defaultHistoTable"
                             id="diagnosisSpotContentButtons#{varCounterOuter.index}"
                             columnClasses="columnWidthMin, columnWidthAuto">

                    <h:panelGroup>
                        <p:splitButton
                                rendered="#{revision.completionDate ne 0 and !worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionInEditAmendmentMode(revision)}"
                                value="#{msg['body.diagnosis.diagnosis.amendment']}"
                                disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                onclick="$('#contentForm\\:admendDiagnosisRevision#{varCounterOuter.index}').click();"
                                icon="fa fa-edit">

                            <!-- delete diagnosis -->
                            <p:menuitem value="#{msg['body.diagnosis.diagnosis.reend']}"
                                        icon="fa fa-eye-slash"
                                        onclick="$('#contentForm\\:endDiagnosisRevision#{varCounterOuter.index}').click();"/>

                        </p:splitButton>

                        <!-- save changes -->
                        <p:commandButton value="#{msg['body.diagnosis.diagnosis.lock']}"
                                         rendered="#{worklistHandler.current.selectedTaskInfo.isDiagnosisRevisionInEditAmendmentMode(revision) }"
                                         oncomplete="PF('diagnosisSpotBlocker#{varCounterOuter.index}').hide()"
                                         icon="fa fa-check-circle-o"
                                         update="diagnosisSpotDiagnosis#{varCounterOuter.index} diagnosisSpotContentSignature#{varCounterOuter.index} diagnosisSpotContentButtons#{varCounterOuter.index}">
                            <f:actionListener
                                    binding="#{globalEditViewHandler.ct.endDiagnosisAmendment(revision)}"></f:actionListener>
                        </p:commandButton>

                        <!-- adment revision -->
                        <p:commandButton style="display:none"
                                         id="admendDiagnosisRevision#{varCounterOuter.index}"
                                         oncomplete="PF('diagnosisSpotBlocker#{varCounterOuter.index}').show()"
                                         update="diagnosisSpotDiagnosis#{varCounterOuter.index} diagnosisSpotContentSignature#{varCounterOuter.index} diagnosisSpotContentButtons#{varCounterOuter.index}">
                            <f:actionListener
                                    binding="#{globalEditViewHandler.ct.beginDiagnosisAmendment(revision)}"></f:actionListener>
                        </p:commandButton>

                        <!-- end diangosis -->
                        <p:commandButton value="#{msg['body.diagnosis.diagnosis.end']}"
                                         icon="fa fa-eye-slash"
                                         id="endDiagnosisRevision#{varCounterOuter.index}"
                                         style="#{(revision.completionDate ne 0) ? 'display:none' : ''}"
                                         disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                         actionListener="#{dialog.diagnosisPhaseExitDialog.initAndPrepareBean(worklistHandler.current.selectedTask, revision)}">
                            <p:ajax event="dialogReturn"
                                    oncomplete="updateAndAutoScrollToSelectedElement('navigationForm:patientNavigationScroll','contentForm:contentScrollPane')"
                                    listener="#{dialogReturnHandler.onDiagnosisPhaseExitReutrn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"/>
                        </p:commandButton>

                    </h:panelGroup>


                    <h:panelGroup>
                        <!-- rename diagnosis -->
                        <p:splitButton value="#{msg['body.diagnosis.diagnosis.rename']}"
                                       disabled="#{!worklistHandler.current.selectedTask.taskStatus.editable}"
                                       onclick="$('#contentForm\\:editDiagnosisRevision#{varCounterOuter.index}').click();"
                                       icon="fa fa-pencil">

                            <!-- delete diagnosis -->
                            <p:menuitem value="#{msg['body.diagnosis.diagnosis.delete']}"
                                        icon="fa fa-trash"
                                        onclick="$('#contentForm\\:deleteRevision#{varCounterOuter.index}').click();"/>

                            <!-- print diagnosis -->
                            <p:menuitem value="#{msg['body.diagnosis.diagnosis.print']}"
                                        icon="fa fa-print" disabled="true"/>
                            <p:separator/>

                            <!-- new diagnosis -->
                            <p:menuitem value="#{msg['body.diagnosis.diagnosis.new']}"
                                        icon="fa fa-plus-circle"
                                        onclick="$('#contentForm\\:newDiagnosisRevision#{varCounterOuter.index}').click();"/>
                        </p:splitButton>

                        <!-- edit diagnosis revision -->
                        <p:commandButton
                                id="editDiagnosisRevision#{varCounterOuter.index}"
                                style="display:none"
                                actionListener="#{dialog.editDiagnosisRevisionsDialog.initAndPrepareBean(worklistHandler.current.selectedTask,revision)}">
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultDialogReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"
                                    oncomplete="updateAndAutoScrollToSelectedElement('navigationForm:patientNavigationScroll','contentForm:contentScrollPane')"/>
                        </p:commandButton>

                        <!-- delete diagnosis revision -->
                        <p:commandButton id="deleteRevision#{varCounterOuter.index}"
                                         style="display:none"
                                         actionListener="#{dialog.deleteDiagnosisRevisionDialog.initAndPrepareBean(revision)}">
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultDialogReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"
                                    oncomplete="updateAndAutoScrollToSelectedElement('navigationForm:patientNavigationScroll','contentForm:contentScrollPane')"/>
                        </p:commandButton>

                        <!-- new diagnosis revision -->
                        <p:commandButton id="newDiagnosisRevision#{varCounterOuter.index}"
                                         style="display:none"
                                         actionListener="#{dialog.createDiagnosisRevisionDialog.initAndPrepareBean(worklistHandler.current.selectedTask)}">
                            <p:ajax event="dialogReturn"
                                    listener="#{dialogReturnHandler.onDefaultDialogReturn}"
                                    update="navigationForm:patientList contentForm:contentPanel headerForm"
                                    oncomplete="updateAndAutoScrollToSelectedElement('navigationForm:patientNavigationScroll','contentForm:contentScrollPane')"/>
                        </p:commandButton>

                        <h:panelGroup id="diagnosisCompleted#{varCounterOuter.index}">
                            <i
                                    class="fa fa-fw fa-rss-square fa-lg #{revision.completionDate ne 0 ? 'icon-green' : 'icon-grey'}"
                                    title=""/>
                            <p:tooltip for="diagnosisCompleted#{varCounterOuter.index}">
                                <h:outputLabel
                                        value="#{revision.completionDate ne 0 ? msg['body.diagnosis.diagnosis.approved'] : msg['body.diagnosis.diagnosis.approved.not']} "/>
                                <h:outputText rendered="#{revision.completionDate ne 0}"
                                              value="#{revision.completionDate}">
                                    <f:convertDateTime type="date" pattern="dd.MM.yyyy HH:mm"/>
                                </h:outputText>
                            </p:tooltip>
                        </h:panelGroup>

                        <h:panelGroup id="notificationsCompleted#{varCounterOuter.index}">
                            <h:panelGroup
                                    rendered="#{revision.notificationStatus != 'NO_NOTFICATION'}">
                                <i
                                        class="fa fa-fw fa-volume-up fa-lg #{revision.notificationDate ne 0 ? 'icon-green' : 'icon-grey'}"
                                        title=""/>
                                <p:tooltip for="notificationsCompleted#{varCounterOuter.index}">
                                    <h:outputLabel
                                            value="#{revision.notificationDate ne 0 ? msg['body.diagnosis.diagnosis.notification'] : msg['body.diagnosis.diagnosis.notification.not']} "/>
                                    <h:outputText rendered="#{revision.notificationDate ne 0}"
                                                  value="#{revision.notificationDate}">
                                        <f:convertDateTime type="date" pattern="dd.MM.yyyy HH:mm"/>
                                    </h:outputText>
                                </p:tooltip>
                            </h:panelGroup>

                            <!-- no notification necessary -->
                            <h:panelGroup
                                    rendered="#{revision.notificationStatus == 'NO_NOTFICATION'}">
                                <i class="fa fa-fw fa-stack-exchange fa-lg icon-orange"/>
                                <p:tooltip for="notificationsCompleted#{varCounterOuter.index}">
                                    <h:outputLabel value="Keine Benachrichtigung druchgefhrt"/>
                                </p:tooltip>
                            </h:panelGroup>

                        </h:panelGroup>
                    </h:panelGroup>
                </h:panelGrid>

            </h:panelGrid>
        </c:forEach>
    </p:panel>

    <script>
        $(document)
            .ready(
                function () {
                    // updating scrollElement for displaying the scroll bar correctly
                    updateAndAutoScrollToSelectedElement('contentForm:contentScrollPane');
                });
    </script>

</ui:composition>

